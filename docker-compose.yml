services:
  
  # This uses the Dockerfile in the current directory to build the Playwright image,
  # to run tests against the Sauce demo app and the Swagger Petstore API.
  playwright:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - ENV=${ENV:-docker}
      - SAUCELABS_PORT=${SAUCELABS_PORT:-3000}
      - SAUCELABS_URL=${SAUCELABS_URL:-http://saucedemo}
      - STANDARDUSER_EMAIL=standard_user
      - STANDARDUSER_PASSWORD=secret_sauce
      - TRACE=${TRACE:-retain-on-first-failure}
      - API_URL=${API_URL:-http://petstore:8080}
    depends_on:
      saucedemo:
        condition: service_healthy
      petstore:
        condition: service_healthy
    volumes:
      - ./test-results:/src/test-results
      - ./playwright-report:/src/playwright-report

# This a docker image for the Sauce demo app, that I build previously.
# https://hub.docker.com/r/aaronflynn490/sauce-demo
# Created from https://github.com/saucelabs/sample-app-web/blob/main/Dockerfile
  saucedemo:
    image: aaronflynn490/sauce-demo
    ports:
      - ${SAUCELABS_PORT:-4999}:3000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

# This is a docker image for the Swagger Petstore API created by Swagger.
# https://hub.docker.com/r/swaggerapi/petstore3
  petstore:
    image: swaggerapi/petstore3
    ports:
      - ${PETSTORE_PORT:-5999}:8080
    healthcheck:
      test: ["CMD", "wget", "-q", "http://localhost:8080/api/v3/store/inventory"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 45s
